"use strict";(()=>{var v=class{constructor(){this.keys={w:!1,a:!1,s:!1,d:!1,attack:!1,interact:!1,num1:!1,num2:!1,num3:!1,num4:!1,num5:!1,num6:!1,num7:!1};this.joystick={active:!1,origin:null,current:{x:0,y:0}};this.btnA={active:!1,x:0,y:0,radius:35,label:"A",pulse:0};this.btnB={active:!1,x:0,y:0,radius:25,label:"B",pulse:0};this.zoomDelta=0;this.mouseX=0;this.mouseY=0;this.isPointerDown=!1;this.keyQueue=[];this.lastAttackAt=0;this.lastInteractAt=0;this.attackCooldown=500;this.interactCooldown=300;this.setupKeyboard(),this.setupTouch(),this.setupMouse()}setupKeyboard(){window.addEventListener("keydown",t=>{let e=t.key.toLowerCase();e in this.keys&&(this.keys[e]=!0),t.code==="KeyE"&&(this.keys.interact=!0),t.key>="1"&&t.key<="7"&&(this.keys[`num${t.key}`]=!0),(t.key.length===1||t.key==="Backspace"||t.key==="Enter")&&this.keyQueue.push(t.key)}),window.addEventListener("keyup",t=>{let e=t.key.toLowerCase();e in this.keys&&(this.keys[e]=!1),t.code==="KeyE"&&(this.keys.interact=!1),t.key>="1"&&t.key<="7"&&(this.keys[`num${t.key}`]=!1)})}setupMouse(){window.addEventListener("mousedown",t=>{this.mouseX=t.clientX,this.mouseY=t.clientY,this.isPointerDown=!0,t.button===0&&(this.keys.attack=!0),t.button===2&&(this.keys.interact=!0)}),window.addEventListener("mouseup",()=>{this.isPointerDown=!1,this.keys.attack=!1,this.keys.interact=!1}),window.addEventListener("mousemove",t=>{this.mouseX=t.clientX,this.mouseY=t.clientY}),window.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("wheel",t=>{this.zoomDelta=-Math.sign(t.deltaY)*.1})}setupTouch(){this.resizeButtons(),window.addEventListener("resize",()=>{this.resizeButtons()}),window.addEventListener("touchstart",t=>this.handleTouch(t),{passive:!1}),window.addEventListener("touchmove",t=>this.handleTouch(t),{passive:!1}),window.addEventListener("touchend",t=>this.handleTouch(t),{passive:!1})}resizeButtons(){let t=window.innerWidth,e=window.innerHeight;this.btnA.x=t-80,this.btnA.y=e-120,this.btnB.x=t-140,this.btnB.y=e-100}handleTouch(t){t.preventDefault();let e=!1,i=!1,n=!1,s=!1;for(let a=0;a<t.touches.length;a++){let r=t.touches[a];if(this.mouseX=r.clientX,this.mouseY=r.clientY,s=!0,r.clientX>window.innerWidth/2)Math.hypot(r.clientX-this.btnA.x,r.clientY-this.btnA.y)<this.btnA.radius*1.5&&(i=!0),Math.hypot(r.clientX-this.btnB.x,r.clientY-this.btnB.y)<this.btnB.radius*1.5&&(n=!0);else{if(!this.joystick.active)this.joystick.active=!0,this.joystick.origin={x:r.clientX,y:r.clientY},this.joystick.current={x:r.clientX,y:r.clientY};else if(this.joystick.origin){let l=r.clientX-this.joystick.origin.x,h=r.clientY-this.joystick.origin.y,o=Math.hypot(l,h),c=50;o>c?this.joystick.current={x:this.joystick.origin.x+l/o*c,y:this.joystick.origin.y+h/o*c}:this.joystick.current={x:r.clientX,y:r.clientY}}e=!0}}e||(this.joystick.active=!1,this.joystick.origin=null),this.btnA.active=i,this.btnB.active=n,this.isPointerDown=s}getState(){let t=0,e=0;if(this.keys.w&&(e-=1),this.keys.s&&(e+=1),this.keys.a&&(t-=1),this.keys.d&&(t+=1),this.joystick.active&&this.joystick.origin){let o=this.joystick.current.x-this.joystick.origin.x,c=this.joystick.current.y-this.joystick.origin.y,u=Math.hypot(o,c);if(u>0){let y=Math.min(u,50)/50;t=o/u*y,e=c/u*y}}else t!==0&&e!==0&&(t*=.707,e*=.707);let i=Date.now(),n=7*60,s=(window.innerWidth-n)/2,a=window.innerHeight-70,r=this.mouseX>=s&&this.mouseX<=s+n&&this.mouseY>=a,l=!1;(this.keys.attack||this.btnA.active)&&!r&&i-this.lastAttackAt>=this.attackCooldown&&(l=!0,this.lastAttackAt=i,this.btnA.pulse=1);let h=!1;return(this.keys.interact||this.btnB.active)&&i-this.lastInteractAt>=this.interactCooldown&&(h=!0,this.lastInteractAt=i,this.btnB.pulse=1),{dx:t,dy:e,attack:l,interact:h}}updateAnimations(t){this.btnA.pulse>0&&(this.btnA.pulse-=t/200),this.btnB.pulse>0&&(this.btnB.pulse-=t/200)}getZoomDelta(){let t=this.zoomDelta;return this.zoomDelta=0,t}};var S=class{constructor(){this.x=0;this.y=0;this.zoom=1;this.targetX=0;this.targetY=0;this.width=window.innerWidth,this.height=window.innerHeight,window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight}follow(t,e){this.targetX=t,this.targetY=e}update(){this.x+=(this.targetX-this.x)*.1,this.y+=(this.targetY-this.y)*.1}setZoom(t){let e=this.zoom+t;this.zoom=Math.max(.5,Math.min(e,2))}};var A=class{constructor(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.camera=new S,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.camera.resize()}lerp(t,e,i){return t+(e-t)*i}render(t,e,i,n,s,a){let r=n.getZoomDelta();if(r!==0&&this.camera.setZoom(r),t&&s&&t.players[s]){let l=t.players[s],h=e?.players[s]||l;this.camera.follow(this.lerp(h.x,l.x,i),this.lerp(h.y,l.y,i))}if(this.camera.update(),this.ctx.fillStyle="#222",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),t){this.drawMap(t);let l=s?t.players[s]:null,h=this.findClosestTarget(t,l);for(let o in t.resources)this.drawResource(t.resources[o],o===h,t,e);for(let o in t.structures)this.drawStructure(t.structures[o],o===h,t,e);for(let o in t.mobs){let c=t.mobs[o],u=e?.mobs[o]||c;this.drawMob(c,this.lerp(u.x,c.x,i),this.lerp(u.y,c.y,i),o===h,t,e)}for(let o in t.players){let c=t.players[o],u=e?.players[o]||c;this.drawPlayer(c,this.lerp(u.x,c.x,i),this.lerp(u.y,c.y,i),o===h,t,e)}}this.ctx.restore(),t?(this.drawUI(n),this.drawHUD(t,s),s&&t.players[s]&&a.render(this.ctx,t.players[s],n)):(this.ctx.fillStyle="#fff",this.ctx.font="20px sans-serif",this.ctx.fillText("Connecting...",50,50))}findClosestTarget(t,e){if(!e)return null;let i=null,n=60,s=(a,r,l)=>{if(a===e.id)return;let h=Math.hypot(e.x-r,e.y-l);h<n&&(n=h,i=a)};for(let a in t.resources)s(a,t.resources[a].x,t.resources[a].y);for(let a in t.structures)s(a,t.structures[a].x,t.structures[a].y);for(let a in t.mobs)s(a,t.mobs[a].x,t.mobs[a].y);for(let a in t.players)s(a,t.players[a].x,t.players[a].y);return i}getScale(t,e,i){let n=e?.players[t]||e?.resources[t]||e?.mobs[t]||e?.structures[t],s=i?.players[t]||i?.resources[t]||i?.mobs[t]||i?.structures[t];if(!n||!s)return 1;let a=n.health??n.amount,r=s.health??s.amount;if(a<r&&(n.lastHitAt=Date.now()),!n.lastHitAt)return 1;let l=Date.now()-n.lastHitAt;return l>250?1:1+Math.sin(l/250*Math.PI)*.2}drawMap(t){this.ctx.fillStyle="#3a3",this.ctx.fillRect(0,0,t.width,t.height),this.ctx.strokeStyle="rgba(0,0,0,0.05)",this.ctx.lineWidth=1;for(let e=0;e<=t.width;e+=100)this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,t.height),this.ctx.stroke();for(let e=0;e<=t.height;e+=100)this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(t.width,e),this.ctx.stroke()}drawResource(t,e,i,n){let s=this.getScale(t.id,i,n);e&&(this.drawOutline(t.x,t.y,22*s,"yellow"),this.drawInteractionTooltip(t.x,t.y,t.r_type,"[A] Gather","")),this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.scale(s,s),this.ctx.beginPath(),t.r_type==="Tree"?this.ctx.fillStyle="#2e2":t.r_type==="Rock"?this.ctx.fillStyle="#888":this.ctx.fillStyle="#ea2",this.ctx.arc(0,0,20,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke(),this.ctx.restore();let a=t.r_type==="Tree"?5:t.r_type==="Rock"?10:1;t.amount<a&&this.drawGauge(t.x,t.y-30,30,4,t.amount/a)}drawStructure(t,e,i,n){let s=this.getScale(t.id,i,n);e&&(this.drawOutline(t.x,t.y,25*s,"white"),this.drawInteractionTooltip(t.x,t.y,t.s_type,"[A] Attack","Use")),this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.scale(s,s),t.s_type==="Torch"?(this.ctx.fillStyle="#fa0",this.ctx.beginPath(),this.ctx.arc(0,0,10,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#fff",this.ctx.stroke()):t.s_type==="Wall"?(this.ctx.fillStyle="#642",this.ctx.fillRect(-20,-20,40,40),this.ctx.strokeRect(-20,-20,40,40)):(this.ctx.fillStyle="#444",this.ctx.fillRect(-25,-25,50,50)),this.ctx.restore();let a=t.s_type==="Wall"?200:t.s_type==="Door"?100:50;t.health<a&&this.drawGauge(t.x,t.y-35,40,4,t.health/a)}drawMob(t,e,i,n,s,a){let r=this.getScale(t.id,s,a);n&&(this.drawOutline(e,i,15*r,"red"),this.drawInteractionTooltip(e,i,t.m_type,"[A] Attack","")),this.ctx.save(),this.ctx.translate(e,i),this.ctx.scale(r,r),this.ctx.fillStyle=t.m_type==="Wolf"?"#999":t.m_type==="Bear"?"#531":"#fff",this.ctx.beginPath(),this.ctx.arc(0,0,12,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke(),this.ctx.restore();let l=t.m_type==="Wolf"?50:t.m_type==="Bear"?200:10;t.health<l&&this.drawGauge(e,i-25,24,4,t.health/l)}drawPlayer(t,e,i,n,s,a){let r=this.getScale(t.id,s,a);n&&(this.drawOutline(e,i,18*r,"red"),this.drawInteractionTooltip(e,i,t.username,"[A] Attack","")),this.ctx.save(),this.ctx.translate(e,i),this.ctx.scale(r,r),this.ctx.fillStyle="#f00",this.ctx.beginPath(),this.ctx.arc(0,0,15,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke(),this.ctx.restore(),this.ctx.fillStyle="white",this.ctx.font="12px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(t.username,e,i-25),t.health<100&&this.drawGauge(e,i-30,30,4,t.health/100)}drawOutline(t,e,i,n){this.ctx.beginPath(),this.ctx.arc(t,e,i,0,Math.PI*2),this.ctx.strokeStyle=n,this.ctx.lineWidth=3,this.ctx.stroke(),this.ctx.lineWidth=1}drawInteractionTooltip(t,e,i,n,s){this.ctx.fillStyle="white",this.ctx.font="bold 14px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(i,t,e-55),this.ctx.font="12px sans-serif";let a=n;s&&(a+=` | [B] ${s}`),this.ctx.fillText(a,t,e-40)}drawGauge(t,e,i,n,s){this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fillRect(t-i/2,e,i,n),this.ctx.fillStyle="rgba(255,0,0,0.6)",this.ctx.fillRect(t-i/2,e,i*Math.max(0,s),n)}drawHUD(t,e){if(!e||!t.players[e])return;let i=t.players[e],n=20;this.drawBarWithLabel(20,n,200,15,i.health/100,"rgba(255,0,0,0.5)","rgba(80,0,0,0.3)","HP"),n+=20,this.drawBarWithLabel(20,n,200,15,i.hunger/100,"rgba(255,165,0,0.5)","rgba(80,40,0,0.3)","HG"),n+=20,this.drawBarWithLabel(20,n,200,15,(100-i.cold)/100,"rgba(0,170,255,0.5)","rgba(0,40,80,0.3)","TP")}drawBarWithLabel(t,e,i,n,s,a,r,l){this.ctx.fillStyle="white",this.ctx.font="bold 12px sans-serif",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(l,t,e+n/2);let h=t+25;this.ctx.fillStyle=r,this.ctx.fillRect(h,e,i,n),this.ctx.fillStyle=a,this.ctx.fillRect(h,e,i*Math.max(0,s),n),this.ctx.strokeStyle="rgba(0,0,0,0.5)",this.ctx.strokeRect(h,e,i,n)}drawUI(t){let e=Date.now();this.drawPieButton(t.btnA.x,t.btnA.y,t.btnA.radius,"A",t.btnA.active,"rgba(211,51,51,0.4)",(e-t.lastAttackAt)/t.attackCooldown),this.drawPieButton(t.btnB.x,t.btnB.y,t.btnB.radius,"B",t.btnB.active,"rgba(51,51,211,0.4)",(e-t.lastInteractAt)/t.interactCooldown)}drawPieButton(t,e,i,n,s,a,r){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,e,i,0,Math.PI*2),this.ctx.fillStyle=s?"rgba(255,255,255,0.2)":a,this.ctx.fill(),this.ctx.strokeStyle="white",this.ctx.stroke(),r<1?(this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.arc(t,e,i,-Math.PI/2,-Math.PI/2+(1-r)*Math.PI*2,!1),this.ctx.fillStyle="rgba(0,0,0,0.4)",this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.font="bold 14px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(((1-r)*(n==="A"?.5:.3)).toFixed(1),t,e)):(this.ctx.fillStyle="white",this.ctx.font="bold 20px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(n,t,e)),this.ctx.restore()}};var R=class{constructor(){this.state=0;this.isMenuOpen=!1;this.activeTab=0;this.joinRequest=!1;this.craftRequest=null;this.slotSelectRequest=null;this.respawnRequest=!1;this.nameUpdateRequest=null;this.swapRequest=null;this.drag=null;this.nameBuffer="";this.isNameFocused=!1;this.toast=null}showAchievement(t){this.toast={ach:t,start:Date.now()}}render(t,e,i){let n=t.canvas.width,s=t.canvas.height;e&&this.activeTab===2&&!this.isNameFocused&&(this.nameBuffer=e.username),this.state===0?this.drawStart(t,n,s):this.state===2?this.drawOver(t,n,s):this.state===1&&e&&(this.drawHotbar(t,e,n,s),this.drawHUD(t,n),this.isMenuOpen&&this.drawMenu(t,e,n,s),this.drag&&(t.save(),t.globalAlpha=.7,this.drawItem(t,this.drag.item,i.mouseX-30,i.mouseY-30,60),t.restore()),this.toast&&this.drawToast(t,n,s))}drawStart(t,e,i){t.fillStyle="#111",t.fillRect(0,0,e,i),t.fillStyle="#eee",t.font="bold 60px sans-serif",t.textAlign="center",t.fillText("kkmypk",e/2,i/3),this.drawBtn(t,(e-200)/2,i/2,200,60,"PLAY",!0)}drawOver(t,e,i){t.fillStyle="rgba(100,0,0,0.8)",t.fillRect(0,0,e,i),t.fillStyle="white",t.font="bold 60px sans-serif",t.textAlign="center",t.fillText("YOU DIED",e/2,i/3),this.drawBtn(t,(e-300)/2,i/2,300,80,"RESPAWN",!0)}drawHUD(t,e){this.drawBtn(t,e-60,20,50,50,"MENU",this.isMenuOpen)}drawMenu(t,e,i,n){t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(0,0,i,n);let s=20,a=s,r=s,l=i-s*2,h=n-s*2;t.fillStyle="rgba(34,34,34,0.9)",t.fillRect(a,r,l,h),t.strokeStyle="#444",t.strokeRect(a,r,l,h),this.drawBtn(t,a+l-40,r+10,30,30,"X",!1);let o=["Bag","Craft","Prof","Help","Achiev"],c=(l-50)/o.length;for(let u=0;u<o.length;u++)this.drawBtn(t,a+u*c,r,c,50,o[u],u===this.activeTab);t.save(),t.translate(a,r+50),this.activeTab===0?this.drawInv(t,e,l):this.activeTab===1?this.drawCraft(t,l):this.activeTab===2?this.drawProf(t,e,l):this.activeTab===3?this.drawGuide(t):this.activeTab===4&&this.drawAch(t,e,l,h-50),t.restore()}drawInv(t,e,i){let{cols:n,size:s,pad:a}=this.getInvLayout(i),r=(i-(n*s+(n-1)*a))/2;for(let l=0;l<30;l++){let h=r+l%n*(s+a),o=40+Math.floor(l/n)*(s+a);t.fillStyle="#111",t.fillRect(h,o,s,s),t.strokeStyle="#555",t.strokeRect(h,o,s,s);let c=e.inventory.slots[l];c&&(!this.drag||this.drag.fromIndex!==l)&&this.drawItem(t,c,h,o,s)}}drawCraft(t,e){let i=[{n:"Pick(W)",c:"WoodPickaxe",q:"10W"},{n:"Pick(S)",c:"StonePickaxe",q:"10W,10S"},{n:"Wall",c:"WoodWall",q:"20W"},{n:"Torch",c:"Torch",q:"2W"}],n=40,s=Math.min(260,e-40),a=(e-s)/2;for(let r of i)this.drawBtn(t,a,n,s,45,`${r.n} (${r.q})`,!1),n+=55}drawProf(t,e,i){t.fillStyle="white",t.textAlign="center",t.fillText(e.username,i/2,80);let n=240,s=45,a=(i-n)/2;t.fillStyle=this.isNameFocused?"#000":"#111",t.fillRect(a,120,n,s),t.strokeStyle=this.isNameFocused?"#4a4":"#555",t.strokeRect(a,120,n,s),t.fillStyle="white",t.textAlign="left",t.fillText((this.nameBuffer||"Type...")+(this.isNameFocused&&Date.now()%1e3<500?"|":""),a+10,150),this.drawBtn(t,(i-160)/2,185,160,40,"Update Name",!1)}drawGuide(t){t.fillStyle="white",t.textAlign="left";let e=40;for(let i of["WASD: Move","A: Attack/Use","B: Interact","1-7: Slot"])t.fillText(i,20,e),e+=25}drawAch(t,e,i,n){t.fillStyle="white",t.textAlign="center",t.font="20px sans-serif",t.fillText(`Unlocked: ${e.achievements.length}`,i/2,30);let s=60,a=e.achievements;if(t.font="16px sans-serif",t.textAlign="left",a.length===0){t.textAlign="center",t.fillStyle="#aaa",t.fillText("No achievements yet.",i/2,s);return}for(let r of a)if(t.fillStyle="#fb4",t.fillText(`\u2605 ${r}`,40,s),s+=30,s>n-20)break}drawToast(t,e,i){if(!this.toast)return;let n=Date.now()-this.toast.start;if(n>3e3){this.toast=null;return}let s=n<200?n/200:n>2800?(3e3-n)/200:1;t.save(),t.globalAlpha=s;let a=300,r=60,l=(e-a)/2,h=i-150;t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(l,h,a,r),t.strokeStyle="#fb4",t.lineWidth=2,t.strokeRect(l,h,a,r),t.fillStyle="#fb4",t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("ACHIEVEMENT UNLOCKED!",l+a/2,h+20),t.fillStyle="white",t.font="14px sans-serif",t.fillText(this.toast.ach.name,l+a/2,h+45),t.restore()}drawHotbar(t,e,i,n){let a=Math.min(50,(i-80)/7),r=10,l=(i-7*(a+r))/2,h=n-a-20;for(let o=0;o<7;o++){let c=l+o*(a+r);t.fillStyle=o===e.active_slot?"#aa0":"#000",t.globalAlpha=.5,t.fillRect(c,h,a,a),t.globalAlpha=1,t.strokeStyle="#fff",t.strokeRect(c,h,a,a);let u=e.inventory.slots[o];u&&(!this.drag||this.drag.fromIndex!==o)&&this.drawItem(t,u,c,h,a)}}drawItem(t,e,i,n,s){t.fillStyle=e.kind.includes("Wood")?"#852":e.kind.includes("Stone")?"#888":e.kind.includes("Meat")?"#f88":"#e22",t.beginPath(),t.arc(i+s/2,n+s/2,s/3,0,Math.PI*2),t.fill(),t.fillStyle="white",t.font="12px sans-serif",t.textAlign="right",t.fillText(e.amount.toString(),i+s-4,n+s-4)}drawBtn(t,e,i,n,s,a,r){t.fillStyle=r?"#4a4":"#444",t.fillRect(e,i,n,s),t.strokeStyle="#fff",t.strokeRect(e,i,n,s),t.fillStyle="white",t.textAlign="center",t.textBaseline="middle",t.font="14px sans-serif",t.fillText(a,e+n/2,i+s/2)}getInvLayout(t){let e=t>600?7:t>400?5:3,i=10,n=Math.min(60,(t-(e+1)*i)/e);return{cols:e,size:n,pad:i}}handleInput(t,e,i,n){if(this.isNameFocused){let s=t.keyQueue.shift();s==="Enter"?(this.nameUpdateRequest=this.nameBuffer,this.isNameFocused=!1):s==="Backspace"?this.nameBuffer=this.nameBuffer.slice(0,-1):s&&s.length===1&&(this.nameBuffer+=s)}else t.keyQueue=[];if(this.state===1&&!this.isMenuOpen)for(let s=1;s<=7;s++)t.keys[`num${s}`]&&(this.slotSelectRequest=s-1);if(t.isPointerDown){let s=t.mouseX,a=t.mouseY;if(this.state===0&&this.hit(s,a,(e-200)/2,i/2,200,60)&&(this.joinRequest=!0,t.isPointerDown=!1),this.state===2&&this.hit(s,a,(e-300)/2,i/2,300,80)&&(this.respawnRequest=!0,t.isPointerDown=!1),this.state===1){if(this.isMenuOpen){let o=e-40;if(this.hit(s,a,20+o-40,30,30,30))this.isMenuOpen=!1;else if(this.hit(s,a,20,20,o,50))this.activeTab=Math.floor((s-20)/(o/5));else if(this.activeTab===0&&n){let{cols:c,size:u,pad:y}=this.getInvLayout(o),P=20+(o-(c*u+(c-1)*y))/2;for(let p=0;p<30;p++){let C=P+p%c*(u+y),D=110+Math.floor(p/c)*(u+y);this.hit(s,a,C,D,u,u)&&n.inventory.slots[p]&&(this.drag={fromIndex:p,item:n.inventory.slots[p],startX:s,startY:a})}}else if(this.activeTab===1){let c=["WoodPickaxe","StonePickaxe","WoodWall","Torch"],u=110,y=Math.min(260,o-40);for(let P of c)this.hit(s,a,20+(o-y)/2,u,y,45)&&(this.craftRequest=P),u+=55}else this.activeTab===2&&(this.hit(s,a,20+(o-160)/2,255,160,40)?(this.nameUpdateRequest=this.nameBuffer,this.isNameFocused=!1):this.hit(s,a,20+(o-240)/2,190,240,45)&&(this.isNameFocused=!0,this.nameBuffer=n?.username||""))}else this.hit(s,a,e-60,20,50,50)&&(this.isMenuOpen=!0);t.isPointerDown=!1}}this.drag&&!t.isPointerDown&&(this.drag=null)}hit(t,e,i,n,s,a){return t>=i&&t<=i+s&&e>=n&&e<=n+a}};var k=new A,x=new v,f=new R,g=null,I=null,M=0,w=null,m=null,b=null,T="kkmypk_token";function W(){let d=location.protocol==="https:"?"wss":"ws",t=localStorage.getItem(T),e=`${d}://${location.host}/ws${t?`?token=${t}`:""}`;m=new WebSocket(e),m.onmessage=i=>{try{let n=JSON.parse(i.data);n.type==="welcome"?(w=n.id,n.token&&localStorage.setItem(T,n.token),f.state=1):n.type==="world"?(I=g,g=n.data,M=Date.now(),f.state===1&&w&&g&&!g.players[w]&&(f.state=2)):n.type==="achievement"&&f.showAchievement(n.data)}catch(n){console.error("Parse error",n)}},m.onopen=()=>{console.log("Connected"),b&&clearInterval(b),b=setInterval(q,50)},m.onclose=()=>{f.state=0,g=null,w=null,b&&(clearInterval(b),b=null)}}function B(){let d=w&&g?g.players[w]:null;if(f.handleInput(x,k.canvas.width,k.canvas.height,d),x.updateAnimations(16),f.state===0)f.render(k.ctx,null,x),f.joinRequest&&(W(),f.joinRequest=!1);else if(f.state===2)f.render(k.ctx,null,x),f.respawnRequest&&(f.respawnRequest=!1,m&&(m.close(),m=null),b&&(clearInterval(b),b=null),localStorage.removeItem(T),location.reload());else{let t=Date.now(),e=Math.min(1,(t-M)/50);k.render(g,I,e,x,w,f),m&&m.readyState===WebSocket.OPEN&&(f.craftRequest&&(m.send(JSON.stringify({craft:f.craftRequest})),f.craftRequest=null),f.slotSelectRequest!==null&&(m.send(JSON.stringify({slot:f.slotSelectRequest})),f.slotSelectRequest=null),f.nameUpdateRequest&&(m.send(JSON.stringify({name:f.nameUpdateRequest})),f.nameUpdateRequest=null),f.swapRequest&&(m.send(JSON.stringify({swapSlots:f.swapRequest})),f.swapRequest=null))}requestAnimationFrame(B)}function q(){if(m&&m.readyState===WebSocket.OPEN&&f.state===1){let d=x.getState();(d.dx!==0||d.dy!==0||d.attack||d.interact||x.isPointerDown)&&m.send(JSON.stringify(d))}}B();})();
