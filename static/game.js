"use strict";(()=>{var A=class{constructor(){this.keys={w:!1,a:!1,s:!1,d:!1,attack:!1,interact:!1,num1:!1,num2:!1,num3:!1,num4:!1,num5:!1,num6:!1,num7:!1};this.joystick={active:!1,origin:null,current:{x:0,y:0}};this.btnA={active:!1,x:0,y:0,radius:35,label:"A",pulse:0};this.btnB={active:!1,x:0,y:0,radius:25,label:"B",pulse:0};this.zoomDelta=0;this.mouseX=0;this.mouseY=0;this.isPointerDown=!1;this.keyQueue=[];this.lastAttackAt=0;this.lastInteractAt=0;this.attackCooldown=500;this.interactCooldown=300;this.setupKeyboard(),this.setupTouch(),this.setupMouse()}setupKeyboard(){window.addEventListener("keydown",e=>{let n=e.key.toLowerCase();n in this.keys&&(this.keys[n]=!0),(e.code==="KeyE"||e.code==="KeyB")&&(this.keys.interact=!0),e.key>="1"&&e.key<="7"&&(this.keys[`num${e.key}`]=!0),(e.key.length===1||e.key==="Backspace"||e.key==="Enter")&&this.keyQueue.push(e.key)}),window.addEventListener("keyup",e=>{let n=e.key.toLowerCase();n in this.keys&&(this.keys[n]=!1),(e.code==="KeyE"||e.code==="KeyB")&&(this.keys.interact=!1),e.key>="1"&&e.key<="7"&&(this.keys[`num${e.key}`]=!1)})}setupMouse(){window.addEventListener("mousedown",e=>{this.mouseX=e.clientX,this.mouseY=e.clientY,this.isPointerDown=!0,e.button===0&&(this.keys.attack=!0),e.button===2&&(this.keys.interact=!0)}),window.addEventListener("mouseup",()=>{this.isPointerDown=!1,this.keys.attack=!1,this.keys.interact=!1}),window.addEventListener("mousemove",e=>{this.mouseX=e.clientX,this.mouseY=e.clientY}),window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("wheel",e=>{this.zoomDelta=-Math.sign(e.deltaY)*.1})}setupTouch(){this.resizeButtons(),window.addEventListener("resize",()=>{this.resizeButtons()}),window.addEventListener("touchstart",e=>this.handleTouch(e),{passive:!1}),window.addEventListener("touchmove",e=>this.handleTouch(e),{passive:!1}),window.addEventListener("touchend",e=>this.handleTouch(e),{passive:!1})}resizeButtons(){let e=window.innerWidth,n=window.innerHeight;this.btnA.x=e-80,this.btnA.y=n-120,this.btnB.x=e-140,this.btnB.y=n-100}handleTouch(e){e.preventDefault();let n=!1,s=!1,i=!1,r=!1;for(let a=0;a<e.touches.length;a++){let l=e.touches[a];if(this.mouseX=l.clientX,this.mouseY=l.clientY,r=!0,l.clientX>window.innerWidth/2)Math.hypot(l.clientX-this.btnA.x,l.clientY-this.btnA.y)<this.btnA.radius*1.5&&(s=!0),Math.hypot(l.clientX-this.btnB.x,l.clientY-this.btnB.y)<this.btnB.radius*1.5&&(i=!0);else{if(!this.joystick.active)this.joystick.active=!0,this.joystick.origin={x:l.clientX,y:l.clientY},this.joystick.current={x:l.clientX,y:l.clientY};else if(this.joystick.origin){let f=l.clientX-this.joystick.origin.x,u=l.clientY-this.joystick.origin.y,o=Math.hypot(f,u),h=50;o>h?this.joystick.current={x:this.joystick.origin.x+f/o*h,y:this.joystick.origin.y+u/o*h}:this.joystick.current={x:l.clientX,y:l.clientY}}n=!0}}n||(this.joystick.active=!1,this.joystick.origin=null),this.btnA.active=s,this.btnB.active=i,this.isPointerDown=r}getState(){let e=0,n=0;if(this.keys.w&&(n-=1),this.keys.s&&(n+=1),this.keys.a&&(e-=1),this.keys.d&&(e+=1),this.joystick.active&&this.joystick.origin){let a=this.joystick.current.x-this.joystick.origin.x,l=this.joystick.current.y-this.joystick.origin.y,f=Math.hypot(a,l);if(f>0){let u=Math.min(f,50)/50;e=a/f*u,n=l/f*u}}else e!==0&&n!==0&&(e*=.707,n*=.707);let s=Date.now(),i=!1;(this.keys.attack&&this.isPointerDown||this.btnA.active)&&s-this.lastAttackAt>=this.attackCooldown&&(i=!0,this.lastAttackAt=s,this.btnA.pulse=1);let r=!1;return(this.keys.interact&&this.isPointerDown||this.keys.interact&&!this.isPointerDown&&this.keys.e||this.btnB.active)&&s-this.lastInteractAt>=this.interactCooldown&&(this.keys.interact||this.btnB.active)&&s-this.lastInteractAt>=this.interactCooldown&&(r=!0,this.lastInteractAt=s,this.btnB.pulse=1),{dx:e,dy:n,attack:i,interact:r}}updateAnimations(e){this.btnA.pulse>0&&(this.btnA.pulse-=e/200),this.btnB.pulse>0&&(this.btnB.pulse-=e/200)}getZoomDelta(){let e=this.zoomDelta;return this.zoomDelta=0,e}};var P=class{constructor(){this.x=0;this.y=0;this.zoom=1;this.targetX=0;this.targetY=0;this.width=window.innerWidth,this.height=window.innerHeight,window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight}follow(e,n){this.targetX=e,this.targetY=n}update(){this.x+=(this.targetX-this.x)*.1,this.y+=(this.targetY-this.y)*.1}setZoom(e){let n=this.zoom+e;this.zoom=Math.max(.5,Math.min(n,2))}};function _(t,e){t.fillStyle="#3a3",t.fillRect(0,0,e.width,e.height),t.strokeStyle="rgba(0,0,0,0.05)",t.lineWidth=1;for(let n=0;n<=e.width;n+=100)t.beginPath(),t.moveTo(n,0),t.lineTo(n,e.height),t.stroke();for(let n=0;n<=e.height;n+=100)t.beginPath(),t.moveTo(0,n),t.lineTo(e.width,n),t.stroke()}function k(t,e,n){return t+(e-t)*n}function w(t,e,n){let s=e?.players[t]||e?.resources[t]||e?.mobs[t]||e?.structures[t],i=n?.players[t]||n?.resources[t]||n?.mobs[t]||n?.structures[t];if(!s||!i)return 1;let r=s.health??s.amount,a=i.health??i.amount;if(r<a&&(s.lastHitAt=Date.now()),!s.lastHitAt)return 1;let l=Date.now()-s.lastHitAt;return l>250?1:1+Math.sin(l/250*Math.PI)*.2}function q(t,e,n,s){n&&(C(t,e.x,e.y,22*s,"yellow"),I(t,e.x,e.y,e.r_type,"Gather","")),t.save(),t.translate(e.x,e.y),t.scale(s,s),t.beginPath(),t.fillStyle=e.r_type==="Tree"?"#2e2":e.r_type==="Rock"?"#888":"#ea2",t.arc(0,0,20,0,Math.PI*2),t.fill(),t.strokeStyle="#000",t.stroke(),t.restore();let i=e.r_type==="Tree"?5:e.r_type==="Rock"?10:1;e.amount<i&&M(t,e.x,e.y-30,30,4,e.amount/i)}function E(t,e,n,s){n&&(C(t,e.x,e.y,25*s,"white"),I(t,e.x,e.y,e.s_type,"Attack","Use")),t.save(),t.translate(e.x,e.y),t.scale(s,s),e.s_type==="Torch"?(t.fillStyle="#fa0",t.beginPath(),t.arc(0,0,10,0,Math.PI*2),t.fill(),t.strokeStyle="#fff",t.stroke()):e.s_type==="Wall"?(t.fillStyle="#642",t.fillRect(-20,-20,40,40),t.strokeRect(-20,-20,40,40)):(t.fillStyle="#444",t.fillRect(-25,-25,50,50)),t.restore();let i=e.s_type==="Wall"?200:e.s_type==="Door"?100:50;e.health<i&&M(t,e.x,e.y-35,40,4,e.health/i)}function x(t,e,n,s,i,r){i&&(C(t,n,s,15*r,"red"),I(t,n,s,e.m_type,"Attack","")),t.save(),t.translate(n,s),t.scale(r,r),t.fillStyle=e.m_type==="Wolf"?"#999":e.m_type==="Bear"?"#531":"#fff",t.beginPath(),t.arc(0,0,12,0,Math.PI*2),t.fill(),t.strokeStyle="#000",t.stroke(),t.restore();let a=e.m_type==="Wolf"?50:e.m_type==="Bear"?200:10;e.health<a&&M(t,n,s-25,24,4,e.health/a)}function j(t,e,n,s,i,r){i&&(C(t,n,s,18*r,"red"),I(t,n,s,e.username,"Attack","")),t.save(),t.translate(n,s),t.scale(r,r),t.fillStyle="#f00",t.beginPath(),t.arc(0,0,15,0,Math.PI*2),t.fill(),t.strokeStyle="#000",t.stroke(),t.restore(),t.fillStyle="white",t.font="12px sans-serif",t.textAlign="center",t.fillText(e.username,n,s-25),e.health<100&&M(t,n,s-30,30,4,e.health/100)}function C(t,e,n,s,i){t.beginPath(),t.arc(e,n,s,0,Math.PI*2),t.strokeStyle=i,t.lineWidth=3,t.stroke(),t.lineWidth=1}function I(t,e,n,s,i,r){t.fillStyle="white",t.font="bold 14px sans-serif",t.textAlign="center",t.fillText(s,e,n-55),t.font="12px sans-serif";let a=`[A/Click] ${i}`;r&&(a+=` | [B/KeyE] ${r}`),t.fillText(a,e,n-40)}function M(t,e,n,s,i,r){t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(e-s/2,n,s,i),t.fillStyle="rgba(255,0,0,0.5)",t.fillRect(e-s/2,n,s*Math.max(0,r),i)}var D=class{constructor(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.camera=new P,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.camera.resize()}render(e,n,s,i,r,a){let l=i.getZoomDelta();if(l!==0&&this.camera.setZoom(l),e&&r&&e.players[r]){let f=e.players[r],u=n?.players[r]||f;this.camera.follow(k(u.x,f.x,s),k(u.y,f.y,s))}if(this.camera.update(),this.ctx.fillStyle="#222",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),e){_(this.ctx,e);let f=r?e.players[r]:null,u=this.findClosestTarget(e,f);for(let o in e.resources)q(this.ctx,e.resources[o],o===u,w(o,e,n));for(let o in e.structures)E(this.ctx,e.structures[o],o===u,w(o,e,n));for(let o in e.mobs){let h=e.mobs[o],c=n?.mobs[o]||h;x(this.ctx,h,k(c.x,h.x,s),k(c.y,h.y,s),o===u,w(o,e,n))}for(let o in e.players){let h=e.players[o],c=n?.players[o]||h;j(this.ctx,h,k(c.x,h.x,s),k(c.y,h.y,s),o===u,w(o,e,n))}}this.ctx.restore(),e?(this.drawUI(i),this.drawHUD(e,r),r&&e.players[r]&&a.render(this.ctx,e.players[r],i)):(this.ctx.fillStyle="#fff",this.ctx.font="20px sans-serif",this.ctx.fillText("Connecting...",50,50))}findClosestTarget(e,n){if(!n)return null;let s=null,i=60,r=(a,l,f)=>{if(a===n.id)return;let u=Math.hypot(n.x-l,n.y-f);u<i&&(i=u,s=a)};for(let a in e.resources)r(a,e.resources[a].x,e.resources[a].y);for(let a in e.structures)r(a,e.structures[a].x,e.structures[a].y);for(let a in e.mobs)r(a,e.mobs[a].x,e.mobs[a].y);for(let a in e.players)r(a,e.players[a].x,e.players[a].y);return s}drawHUD(e,n){if(!n||!e.players[n])return;let s=e.players[n],i=20;this.drawBarWithLabel(20,i,200,15,s.health/100,"rgba(255,0,0,0.5)","rgba(80,0,0,0.3)","HP"),i+=20,this.drawBarWithLabel(20,i,200,15,s.hunger/100,"rgba(255,165,0,0.5)","rgba(80,40,0,0.3)","HG"),i+=20,this.drawBarWithLabel(20,i,200,15,(100-s.cold)/100,"rgba(0,170,255,0.5)","rgba(0,40,80,0.3)","TP")}drawBarWithLabel(e,n,s,i,r,a,l,f){this.ctx.fillStyle="white",this.ctx.font="bold 12px sans-serif",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(f,e,n+i/2);let u=e+25;this.ctx.fillStyle=l,this.ctx.fillRect(u,n,s,i),this.ctx.fillStyle=a,this.ctx.fillRect(u,n,s*Math.max(0,r),i),this.ctx.strokeStyle="rgba(0,0,0,0.5)",this.ctx.strokeRect(u,n,s,i)}drawUI(e){let n=Date.now();this.drawPieButton(e.btnA.x,e.btnA.y,e.btnA.radius,"A",e.btnA.active,"rgba(211,51,51,0.4)",(n-e.lastAttackAt)/e.attackCooldown),this.drawPieButton(e.btnB.x,e.btnB.y,e.btnB.radius,"B",e.btnB.active,"rgba(51,51,211,0.4)",(n-e.lastInteractAt)/e.interactCooldown)}drawPieButton(e,n,s,i,r,a,l){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e,n,s,0,Math.PI*2),this.ctx.fillStyle=r?"rgba(255,255,255,0.2)":a,this.ctx.fill(),this.ctx.strokeStyle="white",this.ctx.stroke(),l<1?(this.ctx.beginPath(),this.ctx.moveTo(e,n),this.ctx.arc(e,n,s,-Math.PI/2,-Math.PI/2+(1-l)*Math.PI*2,!1),this.ctx.fillStyle="rgba(0,0,0,0.4)",this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.font="bold 14px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(((1-l)*(i==="A"?.5:.3)).toFixed(1),e,n)):(this.ctx.fillStyle="white",this.ctx.font="bold 20px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(i,e,n)),this.ctx.restore()}};function L(t,e,n,s,i,r){let{cols:a,size:l,pad:f}=O(n),u=(n-(a*l+(a-1)*f))/2;for(let o=0;o<30;o++){let h=u+o%a*(l+f),c=40+Math.floor(o/a)*(l+f);t.fillStyle="#111",t.fillRect(h,c,l,l),t.strokeStyle="#555",t.strokeRect(h,c,l,l);let d=e.inventory.slots[o];d&&(!i||i.fromIndex!==o)&&r.drawItem(t,d,h,c,l)}}function O(t){let e=t>600?7:t>400?5:3,n=10,s=Math.min(60,(t-(e+1)*n)/e);return{cols:e,size:s,pad:n}}function H(t,e,n,s,i,r){let{cols:a,size:l,pad:f}=O(n),u=(n-(a*l+(a-1)*f))/2;for(let o=0;o<30;o++){let h=u+o%a*(l+f),c=40+Math.floor(o/a)*(l+f);if(r.hit(t,e,h,c,l,l)&&i.inventory.slots[o])return{fromIndex:o,item:i.inventory.slots[o],startX:t,startY:e}}return null}var T=[{name:"Wood Pick",code:"WoodPickaxe",req:{Wood:10}},{name:"Stone Pick",code:"StonePickaxe",req:{Wood:10,Stone:10}},{name:"Wood Wall",code:"WoodWall",req:{Wood:20}},{name:"Torch",code:"Torch",req:{Wood:2}},{name:"Workbench",code:"Workbench",req:{Wood:50}},{name:"Door",code:"Door",req:{Wood:15}}];function X(t,e,n,s,i,r){let a=s*.4,l=40;for(let f of T)n===f.code&&(t.fillStyle="#444",t.fillRect(10,l-5,a-20,40)),t.fillStyle="white",t.font="16px sans-serif",t.textAlign="left",t.fillText(f.name,20,l+20),l+=45;if(n){let f=T.find(u=>u.code===n);if(f){let u=a+20,o=50;t.fillStyle="white",t.font="bold 22px sans-serif",t.fillText(f.name,u,o),o+=40,t.font="16px sans-serif",t.fillStyle="#aaa",t.fillText("Requirements:",u,o),o+=25;let h=!0;for(let[c,d]of Object.entries(f.req)){let b=V(e,c);t.fillStyle=b>=d?"#4f4":"#f44",t.fillText(`${c}: ${b}/${d}`,u,o),b<d&&(h=!1),o+=25}o+=20,r.drawBtn(t,u,o,120,40,"Craft",h)}}}function V(t,e){let n=0;for(let s of t.inventory.slots)s&&s.kind===e&&(n+=s.amount);return n}function z(t,e,n,s,i,r){let a=n*.4,l=40;for(let f of T){if(t>=10&&t<=a-10&&e>=l-5&&e<l+35)return{select:f.code};l+=45}if(r){let f=T.find(u=>u.code===r);if(f){let u=a+20,o=115+Object.keys(f.req).length*25+20;if(t>=u&&t<=u+120&&e>=o&&e<=o+40)return{craft:!0}}}return{}}function Y(t,e,n,s,i,r){let a=i/2;t.fillStyle="white",t.textAlign="center",t.font="20px sans-serif",t.fillText("Achievements",a/2,30);let l=60,f=new Set(e.achievements);for(let u of n){let o=f.has(u.id);s===u.id&&(t.fillStyle="#444",t.fillRect(10,l-20,a-20,30)),t.fillStyle=o?"#fb4":"#888",t.textAlign="left",t.font="16px sans-serif",t.fillText(`${o?"\u2605":"\u{1F512}"} ${u.name}`,20,l),l+=35}if(s){let u=n.find(o=>o.id===s);if(u){let o=a+20,h=60;t.fillStyle="white",t.textAlign="left",t.font="bold 20px sans-serif",t.fillText(u.name,o,h),t.font="14px sans-serif",t.fillStyle="#ccc",t.fillText(u.description,o,h+30),t.fillStyle="#8f8",t.fillText(`Reward: +${(u.stat_bonus[1]*100).toFixed(0)}% ${u.stat_bonus[0]}`,o,h+60);let c=f.has(u.id);t.fillStyle=c?"#4f4":"#f44",t.fillText(c?"UNLOCKED":"LOCKED",o,h+90)}}}function N(t,e,n,s,i){let r=n/2,a=60;for(let l of i){if(t>=10&&t<=r-10&&e>=a-20&&e<=a+10)return l.id;a+=35}return null}function U(t,e,n,s,i,r,a){t.fillStyle="white",t.textAlign="center",t.font="24px sans-serif",t.fillText("Player Profile",n/2,40),t.font="18px sans-serif",t.fillText(`ID: ${e.id.substring(0,8)}...`,n/2,80);let l=120;t.textAlign="left",t.font="16px monospace";let f=[`Kills: ${e.stats?.mobs_killed??0}`,`Deaths: ${e.stats?.deaths??0}`,`Crafted: ${e.stats?.items_crafted??0}`,`Steps: ${e.stats?.steps_taken??0}`];for(let b of f)t.fillText(b,n/2-80,l),l+=25;let u=240,o=45,h=(n-u)/2,c=l+20;t.fillStyle=r?"#000":"#111",t.fillRect(h,c,u,o),t.strokeStyle=r?"#4a4":"#555",t.strokeRect(h,c,u,o),t.fillStyle="white",t.textAlign="left";let d=i;r&&Date.now()%1e3<500&&(d+="|"),t.fillText(d||(r?"":"Type Name..."),h+10,c+30),a.drawBtn(t,(n-160)/2,c+60,160,40,"Update Name",!1)}function $(t,e,n,s,i,r){let a=220,l=240,f=45,u=(n-l)/2,o=a+20;return r.hit(t,e,u,o,l,f)?{focus:!0}:r.hit(t,e,(n-160)/2,o+60,160,40)?{update:!0}:{focus:!1}}function F(t,e,n,s){t.fillStyle="#111",t.fillRect(0,0,e,n),t.fillStyle="#eee",t.font="bold 60px sans-serif",t.textAlign="center",t.fillText("kkmypk",e/2,n/3),s.drawBtn(t,(e-200)/2,n/2,200,60,"PLAY",!0)}function G(t,e,n,s){t.fillStyle="rgba(0,0,0,0.9)",t.fillRect(0,0,e,n),t.fillStyle="white",t.font="bold 60px sans-serif",t.textAlign="center",t.fillText("YOU DIED",e/2,n/3),s.drawBtn(t,(e-300)/2,n/2,300,80,"Return to Menu",!0)}var K=[{id:"NoviceWalker",name:"Novice Walker",description:"Walk 1,000 steps",stat_bonus:["speed",.01]},{id:"MarathonRunner",name:"Marathon Runner",description:"Walk 100,000 steps",stat_bonus:["speed",.05]},{id:"FirstBlood",name:"First Blood",description:"Kill 1 mob",stat_bonus:["damage",.01]},{id:"MonsterHunter",name:"Monster Hunter",description:"Kill 100 mobs",stat_bonus:["damage",.02]},{id:"Slayer",name:"Slayer",description:"Kill 1,000 mobs",stat_bonus:["damage",.05]},{id:"Lumberjack",name:"Lumberjack",description:"Chop 100 trees",stat_bonus:["gather",.02]},{id:"Deforestation",name:"Deforestation",description:"Chop 1,000 trees",stat_bonus:["gather",.05]},{id:"Miner",name:"Miner",description:"Mine 100 rocks",stat_bonus:["gather",.02]},{id:"DeepDriller",name:"Deep Driller",description:"Mine 1,000 rocks",stat_bonus:["gather",.05]},{id:"ApprenticeSmith",name:"Apprentice Smith",description:"Craft 10 items",stat_bonus:["craft",.02]},{id:"MasterSmith",name:"Master Smith",description:"Craft 1,000 items",stat_bonus:["craft",.05]},{id:"Builder",name:"Builder",description:"Place 50 structures",stat_bonus:["max_hp",.05]},{id:"Architect",name:"Architect",description:"Place 500 structures",stat_bonus:["max_hp",.2]}],B=class{constructor(){this.state=0;this.isMenuOpen=!1;this.activeTab=0;this.joinRequest=!1;this.craftRequest=null;this.slotSelectRequest=null;this.respawnRequest=!1;this.nameUpdateRequest=null;this.swapRequest=null;this.drag=null;this.nameBuffer="";this.isNameFocused=!1;this.toast=null;this.selectedAchId=null;this.selectedRecipe=null}showAchievement(e){this.toast={ach:e,start:Date.now()}}render(e,n,s){let i=e.canvas.width,r=e.canvas.height;n&&this.activeTab===2&&!this.isNameFocused&&(this.nameBuffer=n.username),this.state===0?F(e,i,r,this):this.state===2?G(e,i,r,this):this.state===1&&n&&(this.drawHotbar(e,n,i,r),this.drawHUD(e,i),this.isMenuOpen&&this.drawMenu(e,n,i,r),this.drag&&(e.save(),e.globalAlpha=.7,this.drawItem(e,this.drag.item,s.mouseX-30,s.mouseY-30,60),e.restore()),this.toast&&this.drawToast(e,i,r))}drawHUD(e,n){let s=n-60,i=20,r=50;e.fillStyle=this.isMenuOpen?"rgba(74,164,74,0.6)":"rgba(68,68,68,0.6)",e.fillRect(s,i,r,r),e.strokeStyle="#fff",e.strokeRect(s,i,r,r),e.fillStyle="white",e.fillRect(s+10,i+12,30,4),e.fillRect(s+10,i+23,30,4),e.fillRect(s+10,i+34,30,4)}drawMenu(e,n,s,i){e.fillStyle="rgba(0,0,0,0.6)",e.fillRect(0,0,s,i);let r=20,a=r,l=r,f=s-r*2,u=i-r*2;e.fillStyle="rgba(34,34,34,0.95)",e.fillRect(a,l,f,u),e.strokeStyle="#444",e.strokeRect(a,l,f,u),this.drawBtn(e,a+f-40,l+10,30,30,"X",!1);let o=["Bag","Craft","Prof","Help","Achiev"],h=(f-50)/o.length;for(let c=0;c<o.length;c++)this.drawBtn(e,a+c*h,l,h,50,o[c],c===this.activeTab);if(e.save(),e.translate(a,l+50),this.activeTab===0)L(e,n,f,u-50,this.drag,this);else if(this.activeTab===1)X(e,n,this.selectedRecipe,f,u-50,this);else if(this.activeTab===2)U(e,n,f,u-50,this.nameBuffer,this.isNameFocused,this);else if(this.activeTab===3){e.fillStyle="white",e.textAlign="left";let c=40;for(let d of["WASD: Move","LeftClick/Space: Attack/Use","RightClick/Shift: Interact","1-7: Slot"])e.fillText(d,20,c),c+=25}else this.activeTab===4&&Y(e,n,K,this.selectedAchId,f,u-50);e.restore()}drawToast(e,n,s){if(!this.toast)return;let i=Date.now()-this.toast.start;if(i>3e3){this.toast=null;return}let r=i<200?i/200:i>2800?(3e3-i)/200:1;e.save(),e.globalAlpha=r;let a=300,l=60,f=(n-a)/2,u=s-150;e.fillStyle="rgba(0,0,0,0.8)",e.fillRect(f,u,a,l),e.strokeStyle="#fb4",e.strokeRect(f,u,a,l),e.fillStyle="#fb4",e.font="bold 16px sans-serif",e.textAlign="center",e.fillText("ACHIEVEMENT UNLOCKED!",f+a/2,u+20),e.fillStyle="white",e.font="14px sans-serif",e.fillText(this.toast.ach.name,f+a/2,u+45),e.restore()}drawHotbar(e,n,s,i){let a=Math.min(50,(s-80)/7),l=10,f=(s-7*(a+l))/2,u=i-a-20;for(let o=0;o<7;o++){let h=f+o*(a+l);e.fillStyle=o===n.active_slot?"#aa0":"#000",e.globalAlpha=.5,e.fillRect(h,u,a,a),e.globalAlpha=1,e.strokeStyle="#fff",e.strokeRect(h,u,a,a);let c=n.inventory.slots[o];c&&(!this.drag||this.drag.fromIndex!==o)&&this.drawItem(e,c,h,u,a)}}drawItem(e,n,s,i,r){e.fillStyle=n.kind.includes("Wood")?"#852":n.kind.includes("Stone")?"#888":n.kind.includes("Meat")?"#f88":"#e22",e.beginPath(),e.arc(s+r/2,i+r/2,r/3,0,Math.PI*2),e.fill(),e.fillStyle="white",e.font="12px sans-serif",e.textAlign="right",e.fillText(n.amount.toString(),s+r-4,i+r-4)}drawBtn(e,n,s,i,r,a,l){e.fillStyle=l?"#4a4":"#444",e.fillRect(n,s,i,r),e.strokeStyle="#fff",e.strokeRect(n,s,i,r),e.fillStyle="white",e.textAlign="center",e.textBaseline="middle",e.font="14px sans-serif",e.fillText(a,n+i/2,s+r/2)}handleInput(e,n,s,i){if(this.isNameFocused){let r=e.keyQueue.shift();r==="Enter"?(this.nameUpdateRequest=this.nameBuffer,this.isNameFocused=!1):r==="Backspace"?this.nameBuffer=this.nameBuffer.slice(0,-1):r&&r.length===1&&(this.nameBuffer+=r)}else e.keyQueue=[];if(e.isPointerDown){let r=e.mouseX,a=e.mouseY;if(this.state===0&&this.hit(r,a,(n-200)/2,s/2,200,60))this.joinRequest=!0;else if(this.state===2&&this.hit(r,a,(n-300)/2,s/2,300,80))this.respawnRequest=!0;else if(this.state===1)if(this.isMenuOpen){let o=n-40,h=s-20*2;if(this.hit(r,a,20+o-40,30,30,30))this.isMenuOpen=!1;else if(this.hit(r,a,20,20,o,50))this.activeTab=Math.floor((r-20)/(o/5));else{let c=r-20,d=a-70;if(c>=0&&d>=0&&c<=o&&d<=h-50){if(this.activeTab===0&&i){let b=H(c,d,o,h-50,i,this);b&&(this.drag=b)}else if(this.activeTab===1&&i){let b=z(c,d,o,h-50,i,this.selectedRecipe);b.select&&(this.selectedRecipe=b.select),b.craft&&(this.craftRequest=this.selectedRecipe)}else if(this.activeTab===2&&i){let b=$(c,d,o,h-50,i,this);b.focus?(this.isNameFocused=!0,this.nameBuffer=i.username):b.update?(this.nameUpdateRequest=this.nameBuffer,this.isNameFocused=!1):this.isNameFocused=!1}else if(this.activeTab===4){let b=N(c,d,o,h-50,K);b&&(this.selectedAchId=b)}}}}else{this.hit(r,a,n-60,20,50,50)&&(this.isMenuOpen=!0);let l=7,f=Math.min(50,(n-80)/7),u=10,o=(n-l*(f+u))/2,h=s-f-20;if(this.hit(r,a,o,h,l*(f+u),f)){let c=Math.floor((r-o)/(f+u));c>=0&&c<7&&(this.slotSelectRequest=c)}}e.isPointerDown=!1}if(this.drag&&!e.isPointerDown&&i){let r=e.mouseX,a=e.mouseY;this.drag=null}}hit(e,n,s,i,r,a){return e>=s&&e<=s+r&&n>=i&&n<=i+a}};var R=new D,v=new A,m=new B,g=null,J=null,Z=0,S=null,y=null,p=null,W="kkmypk_token";function te(){let t=location.protocol==="https:"?"wss":"ws",e=localStorage.getItem(W),n=`${t}://${location.host}/ws${e?`?token=${e}`:""}`;y=new WebSocket(n),y.onmessage=s=>{try{let i=JSON.parse(s.data);i.type==="welcome"?(S=i.id,i.token&&localStorage.setItem(W,i.token),m.state=1):i.type==="world"?(J=g,g=i.data,Z=Date.now(),m.state===1&&S&&g&&!g.players[S]&&(m.state=2)):i.type==="achievement"&&m.showAchievement(i.data)}catch(i){console.error("Parse error",i)}},y.onopen=()=>{console.log("Connected"),p&&clearInterval(p),p=setInterval(ne,50)},y.onclose=()=>{m.state=0,g=null,S=null,p&&(clearInterval(p),p=null)}}function Q(){let t=S&&g?g.players[S]:null;if(m.handleInput(v,R.canvas.width,R.canvas.height,t),v.updateAnimations(16),m.state===0)m.render(R.ctx,null,v),m.joinRequest&&(te(),m.joinRequest=!1);else if(m.state===2)m.render(R.ctx,null,v),m.respawnRequest&&(m.respawnRequest=!1,y&&(y.close(),y=null),p&&(clearInterval(p),p=null),localStorage.removeItem(W),location.reload());else{let e=Date.now(),n=Math.min(1,(e-Z)/50);R.render(g,J,n,v,S,m),y&&y.readyState===WebSocket.OPEN&&(m.craftRequest&&(y.send(JSON.stringify({craft:m.craftRequest})),m.craftRequest=null),m.slotSelectRequest!==null&&(y.send(JSON.stringify({slot:m.slotSelectRequest})),m.slotSelectRequest=null),m.nameUpdateRequest&&(y.send(JSON.stringify({name:m.nameUpdateRequest})),m.nameUpdateRequest=null),m.swapRequest&&(y.send(JSON.stringify({swapSlots:m.swapRequest})),m.swapRequest=null))}requestAnimationFrame(Q)}function ne(){if(y&&y.readyState===WebSocket.OPEN&&m.state===1){let t=v.getState();(t.dx!==0||t.dy!==0||t.attack||t.interact||v.isPointerDown)&&y.send(JSON.stringify(t))}}Q();})();
