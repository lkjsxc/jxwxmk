"use strict";(()=>{var A=class{constructor(){this.keys={w:!1,a:!1,s:!1,d:!1,attack:!1,interact:!1,num1:!1,num2:!1,num3:!1,num4:!1,num5:!1,num6:!1,num7:!1};this.joystick={active:!1,origin:null,current:{x:0,y:0}};this.btnA={active:!1,x:0,y:0,radius:35,label:"A",pulse:0};this.btnB={active:!1,x:0,y:0,radius:25,label:"B",pulse:0};this.zoomDelta=0;this.mouseX=0;this.mouseY=0;this.isPointerDown=!1;this.keyQueue=[];this.lastAttackAt=0;this.lastInteractAt=0;this.attackCooldown=500;this.interactCooldown=300;this.setupKeyboard(),this.setupTouch(),this.setupMouse()}setupKeyboard(){window.addEventListener("keydown",t=>{let e=t.key.toLowerCase();e in this.keys&&(this.keys[e]=!0),(t.code==="KeyE"||t.code==="KeyB")&&(this.keys.interact=!0),t.key>="1"&&t.key<="7"&&(this.keys[`num${t.key}`]=!0),(t.key.length===1||t.key==="Backspace"||t.key==="Enter")&&this.keyQueue.push(t.key)}),window.addEventListener("keyup",t=>{let e=t.key.toLowerCase();e in this.keys&&(this.keys[e]=!1),(t.code==="KeyE"||t.code==="KeyB")&&(this.keys.interact=!1),t.key>="1"&&t.key<="7"&&(this.keys[`num${t.key}`]=!1)})}setupMouse(){window.addEventListener("mousedown",t=>{this.mouseX=t.clientX,this.mouseY=t.clientY,this.isPointerDown=!0,t.button===0&&(this.keys.attack=!0),t.button===2&&(this.keys.interact=!0)}),window.addEventListener("mouseup",()=>{this.isPointerDown=!1,this.keys.attack=!1,this.keys.interact=!1}),window.addEventListener("mousemove",t=>{this.mouseX=t.clientX,this.mouseY=t.clientY}),window.addEventListener("contextmenu",t=>t.preventDefault()),window.addEventListener("wheel",t=>{this.zoomDelta=-Math.sign(t.deltaY)*.1})}setupTouch(){this.resizeButtons(),window.addEventListener("resize",()=>{this.resizeButtons()}),window.addEventListener("touchstart",t=>this.handleTouch(t),{passive:!1}),window.addEventListener("touchmove",t=>this.handleTouch(t),{passive:!1}),window.addEventListener("touchend",t=>this.handleTouch(t),{passive:!1})}resizeButtons(){let t=window.innerWidth,e=window.innerHeight;this.btnA.x=t-80,this.btnA.y=e-120,this.btnB.x=t-140,this.btnB.y=e-100}handleTouch(t){t.preventDefault();let e=!1,i=!1,s=!1,n=!1;for(let r=0;r<t.touches.length;r++){let l=t.touches[r];if(this.mouseX=l.clientX,this.mouseY=l.clientY,n=!0,l.clientX>window.innerWidth/2)Math.hypot(l.clientX-this.btnA.x,l.clientY-this.btnA.y)<this.btnA.radius*1.5&&(i=!0),Math.hypot(l.clientX-this.btnB.x,l.clientY-this.btnB.y)<this.btnB.radius*1.5&&(s=!0);else{if(!this.joystick.active)this.joystick.active=!0,this.joystick.origin={x:l.clientX,y:l.clientY},this.joystick.current={x:l.clientX,y:l.clientY};else if(this.joystick.origin){let c=l.clientX-this.joystick.origin.x,h=l.clientY-this.joystick.origin.y,o=Math.hypot(c,h),f=50;o>f?this.joystick.current={x:this.joystick.origin.x+c/o*f,y:this.joystick.origin.y+h/o*f}:this.joystick.current={x:l.clientX,y:l.clientY}}e=!0}}e||(this.joystick.active=!1,this.joystick.origin=null),this.btnA.active=i,this.btnB.active=s,this.isPointerDown=n}getState(){let t=0,e=0;if(this.keys.w&&(e-=1),this.keys.s&&(e+=1),this.keys.a&&(t-=1),this.keys.d&&(t+=1),this.joystick.active&&this.joystick.origin){let r=this.joystick.current.x-this.joystick.origin.x,l=this.joystick.current.y-this.joystick.origin.y,c=Math.hypot(r,l);if(c>0){let h=Math.min(c,50)/50;t=r/c*h,e=l/c*h}}else t!==0&&e!==0&&(t*=.707,e*=.707);let i=Date.now(),s=!1;(this.keys.attack&&this.isPointerDown||this.btnA.active)&&i-this.lastAttackAt>=this.attackCooldown&&(s=!0,this.lastAttackAt=i,this.btnA.pulse=1);let n=!1;return(this.keys.interact&&this.isPointerDown||this.keys.interact&&!this.isPointerDown&&this.keys.e||this.btnB.active)&&i-this.lastInteractAt>=this.interactCooldown&&(this.keys.interact||this.btnB.active)&&i-this.lastInteractAt>=this.interactCooldown&&(n=!0,this.lastInteractAt=i,this.btnB.pulse=1),{dx:t,dy:e,attack:s,interact:n}}updateAnimations(t){this.btnA.pulse>0&&(this.btnA.pulse-=t/200),this.btnB.pulse>0&&(this.btnB.pulse-=t/200)}getZoomDelta(){let t=this.zoomDelta;return this.zoomDelta=0,t}};var R=class{constructor(){this.x=0;this.y=0;this.zoom=1;this.targetX=0;this.targetY=0;this.width=window.innerWidth,this.height=window.innerHeight,window.addEventListener("resize",()=>this.resize())}resize(){this.width=window.innerWidth,this.height=window.innerHeight}follow(t,e){this.targetX=t,this.targetY=e}update(){this.x+=(this.targetX-this.x)*.1,this.y+=(this.targetY-this.y)*.1}setZoom(t){let e=this.zoom+t;this.zoom=Math.max(.5,Math.min(e,2))}};var P=class{constructor(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.camera=new R,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.camera.resize()}lerp(t,e,i){return t+(e-t)*i}render(t,e,i,s,n,r){let l=s.getZoomDelta();if(l!==0&&this.camera.setZoom(l),t&&n&&t.players[n]){let c=t.players[n],h=e?.players[n]||c;this.camera.follow(this.lerp(h.x,c.x,i),this.lerp(h.y,c.y,i))}if(this.camera.update(),this.ctx.fillStyle="#222",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.save(),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),t){this.drawMap(t);let c=n?t.players[n]:null,h=this.findClosestTarget(t,c);for(let o in t.resources)this.drawResource(t.resources[o],o===h,t,e);for(let o in t.structures)this.drawStructure(t.structures[o],o===h,t,e);for(let o in t.mobs){let f=t.mobs[o],u=e?.mobs[o]||f;this.drawMob(f,this.lerp(u.x,f.x,i),this.lerp(u.y,f.y,i),o===h,t,e)}for(let o in t.players){let f=t.players[o],u=e?.players[o]||f;this.drawPlayer(f,this.lerp(u.x,f.x,i),this.lerp(u.y,f.y,i),o===h,t,e)}}this.ctx.restore(),t?(this.drawUI(s),this.drawHUD(t,n),n&&t.players[n]&&r.render(this.ctx,t.players[n],s)):(this.ctx.fillStyle="#fff",this.ctx.font="20px sans-serif",this.ctx.fillText("Connecting...",50,50))}findClosestTarget(t,e){if(!e)return null;let i=null,s=60,n=(r,l,c)=>{if(r===e.id)return;let h=Math.hypot(e.x-l,e.y-c);h<s&&(s=h,i=r)};for(let r in t.resources)n(r,t.resources[r].x,t.resources[r].y);for(let r in t.structures)n(r,t.structures[r].x,t.structures[r].y);for(let r in t.mobs)n(r,t.mobs[r].x,t.mobs[r].y);for(let r in t.players)n(r,t.players[r].x,t.players[r].y);return i}getScale(t,e,i){let s=e?.players[t]||e?.resources[t]||e?.mobs[t]||e?.structures[t],n=i?.players[t]||i?.resources[t]||i?.mobs[t]||i?.structures[t];if(!s||!n)return 1;let r=s.health??s.amount,l=n.health??n.amount;if(r<l&&(s.lastHitAt=Date.now()),!s.lastHitAt)return 1;let c=Date.now()-s.lastHitAt;return c>250?1:1+Math.sin(c/250*Math.PI)*.2}drawMap(t){this.ctx.fillStyle="#3a3",this.ctx.fillRect(0,0,t.width,t.height),this.ctx.strokeStyle="rgba(0,0,0,0.05)",this.ctx.lineWidth=1;for(let e=0;e<=t.width;e+=100)this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,t.height),this.ctx.stroke();for(let e=0;e<=t.height;e+=100)this.ctx.beginPath(),this.ctx.moveTo(0,e),this.ctx.lineTo(t.width,e),this.ctx.stroke()}drawResource(t,e,i,s){let n=this.getScale(t.id,i,s);e&&(this.drawOutline(t.x,t.y,22*n,"yellow"),this.drawInteractionTooltip(t.x,t.y,t.r_type,"Gather","")),this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.scale(n,n),this.ctx.beginPath(),t.r_type==="Tree"?this.ctx.fillStyle="#2e2":t.r_type==="Rock"?this.ctx.fillStyle="#888":this.ctx.fillStyle="#ea2",this.ctx.arc(0,0,20,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke(),this.ctx.restore();let r=t.r_type==="Tree"?5:t.r_type==="Rock"?10:1;t.amount<r&&this.drawGauge(t.x,t.y-30,30,4,t.amount/r)}drawStructure(t,e,i,s){let n=this.getScale(t.id,i,s);e&&(this.drawOutline(t.x,t.y,25*n,"white"),this.drawInteractionTooltip(t.x,t.y,t.s_type,"Attack","Use")),this.ctx.save(),this.ctx.translate(t.x,t.y),this.ctx.scale(n,n),t.s_type==="Torch"?(this.ctx.fillStyle="#fa0",this.ctx.beginPath(),this.ctx.arc(0,0,10,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#fff",this.ctx.stroke()):t.s_type==="Wall"?(this.ctx.fillStyle="#642",this.ctx.fillRect(-20,-20,40,40),this.ctx.strokeRect(-20,-20,40,40)):(this.ctx.fillStyle="#444",this.ctx.fillRect(-25,-25,50,50)),this.ctx.restore();let r=t.s_type==="Wall"?200:t.s_type==="Door"?100:50;t.health<r&&this.drawGauge(t.x,t.y-35,40,4,t.health/r)}drawMob(t,e,i,s,n,r){let l=this.getScale(t.id,n,r);s&&(this.drawOutline(e,i,15*l,"red"),this.drawInteractionTooltip(e,i,t.m_type,"Attack","")),this.ctx.save(),this.ctx.translate(e,i),this.ctx.scale(l,l),this.ctx.fillStyle=t.m_type==="Wolf"?"#999":t.m_type==="Bear"?"#531":"#fff",this.ctx.beginPath(),this.ctx.arc(0,0,12,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke(),this.ctx.restore();let c=t.m_type==="Wolf"?50:t.m_type==="Bear"?200:10;t.health<c&&this.drawGauge(e,i-25,24,4,t.health/c)}drawPlayer(t,e,i,s,n,r){let l=this.getScale(t.id,n,r);s&&(this.drawOutline(e,i,18*l,"red"),this.drawInteractionTooltip(e,i,t.username,"Attack","")),this.ctx.save(),this.ctx.translate(e,i),this.ctx.scale(l,l),this.ctx.fillStyle="#f00",this.ctx.beginPath(),this.ctx.arc(0,0,15,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="#000",this.ctx.stroke(),this.ctx.restore(),this.ctx.fillStyle="white",this.ctx.font="12px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(t.username,e,i-25),t.health<100&&this.drawGauge(e,i-30,30,4,t.health/100)}drawOutline(t,e,i,s){this.ctx.beginPath(),this.ctx.arc(t,e,i,0,Math.PI*2),this.ctx.strokeStyle=s,this.ctx.lineWidth=3,this.ctx.stroke(),this.ctx.lineWidth=1}drawInteractionTooltip(t,e,i,s,n){this.ctx.fillStyle="white",this.ctx.font="bold 14px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(i,t,e-55),this.ctx.font="12px sans-serif";let r=`[A/Click] ${s}`;n&&(r+=` | [B/KeyE] ${n}`),this.ctx.fillText(r,t,e-40)}drawGauge(t,e,i,s,n){this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fillRect(t-i/2,e,i,s),this.ctx.fillStyle="rgba(255,0,0,0.5)",this.ctx.fillRect(t-i/2,e,i*Math.max(0,n),s)}drawHUD(t,e){if(!e||!t.players[e])return;let i=t.players[e],s=20;this.drawBarWithLabel(20,s,200,15,i.health/100,"rgba(255,0,0,0.5)","rgba(80,0,0,0.3)","HP"),s+=20,this.drawBarWithLabel(20,s,200,15,i.hunger/100,"rgba(255,165,0,0.5)","rgba(80,40,0,0.3)","HG"),s+=20,this.drawBarWithLabel(20,s,200,15,(100-i.cold)/100,"rgba(0,170,255,0.5)","rgba(0,40,80,0.3)","TP")}drawBarWithLabel(t,e,i,s,n,r,l,c){this.ctx.fillStyle="white",this.ctx.font="bold 12px sans-serif",this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.fillText(c,t,e+s/2);let h=t+25;this.ctx.fillStyle=l,this.ctx.fillRect(h,e,i,s),this.ctx.fillStyle=r,this.ctx.fillRect(h,e,i*Math.max(0,n),s),this.ctx.strokeStyle="rgba(0,0,0,0.5)",this.ctx.strokeRect(h,e,i,s)}drawUI(t){let e=Date.now();this.drawPieButton(t.btnA.x,t.btnA.y,t.btnA.radius,"A",t.btnA.active,"rgba(211,51,51,0.4)",(e-t.lastAttackAt)/t.attackCooldown),this.drawPieButton(t.btnB.x,t.btnB.y,t.btnB.radius,"B",t.btnB.active,"rgba(51,51,211,0.4)",(e-t.lastInteractAt)/t.interactCooldown)}drawPieButton(t,e,i,s,n,r,l){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t,e,i,0,Math.PI*2),this.ctx.fillStyle=n?"rgba(255,255,255,0.2)":r,this.ctx.fill(),this.ctx.strokeStyle="white",this.ctx.stroke(),l<1?(this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.arc(t,e,i,-Math.PI/2,-Math.PI/2+(1-l)*Math.PI*2,!1),this.ctx.fillStyle="rgba(0,0,0,0.4)",this.ctx.fill(),this.ctx.fillStyle="white",this.ctx.font="bold 14px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(((1-l)*(s==="A"?.5:.3)).toFixed(1),t,e)):(this.ctx.fillStyle="white",this.ctx.font="bold 20px sans-serif",this.ctx.textAlign="center",this.ctx.fillText(s,t,e)),this.ctx.restore()}};function C(a,t,e,i,s,n){let{cols:r,size:l,pad:c}=D(e),h=(e-(r*l+(r-1)*c))/2;for(let o=0;o<30;o++){let f=h+o%r*(l+c),u=40+Math.floor(o/r)*(l+c);a.fillStyle="#111",a.fillRect(f,u,l,l),a.strokeStyle="#555",a.strokeRect(f,u,l,l);let d=t.inventory.slots[o];d&&(!s||s.fromIndex!==o)&&n.drawItem(a,d,f,u,l)}}function D(a){let t=a>600?7:a>400?5:3,e=10,i=Math.min(60,(a-(t+1)*e)/t);return{cols:t,size:i,pad:e}}function B(a,t,e,i,s,n){let{cols:r,size:l,pad:c}=D(e),h=(e-(r*l+(r-1)*c))/2;for(let o=0;o<30;o++){let f=h+o%r*(l+c),u=40+Math.floor(o/r)*(l+c);if(n.hit(a,t,f,u,l,l)&&s.inventory.slots[o])return{fromIndex:o,item:s.inventory.slots[o],startX:a,startY:t}}return null}var I=[{name:"Wood Pick",code:"WoodPickaxe",req:{Wood:10}},{name:"Stone Pick",code:"StonePickaxe",req:{Wood:10,Stone:10}},{name:"Wood Wall",code:"WoodWall",req:{Wood:20}},{name:"Torch",code:"Torch",req:{Wood:2}},{name:"Workbench",code:"Workbench",req:{Wood:50}},{name:"Door",code:"Door",req:{Wood:15}}];function W(a,t,e,i,s,n){let r=i*.4,l=40;for(let c of I)e===c.code&&(a.fillStyle="#444",a.fillRect(10,l-5,r-20,40)),a.fillStyle="white",a.font="16px sans-serif",a.textAlign="left",a.fillText(c.name,20,l+20),l+=45;if(e){let c=I.find(h=>h.code===e);if(c){let h=r+20,o=50;a.fillStyle="white",a.font="bold 22px sans-serif",a.fillText(c.name,h,o),o+=40,a.font="16px sans-serif",a.fillStyle="#aaa",a.fillText("Requirements:",h,o),o+=25;let f=!0;for(let[u,d]of Object.entries(c.req)){let b=U(t,u);a.fillStyle=b>=d?"#4f4":"#f44",a.fillText(`${u}: ${b}/${d}`,h,o),b<d&&(f=!1),o+=25}o+=20,n.drawBtn(a,h,o,120,40,"Craft",f)}}}function U(a,t){let e=0;for(let i of a.inventory.slots)i&&i.kind===t&&(e+=i.amount);return e}function _(a,t,e,i,s,n){let r=e*.4,l=40;for(let c of I){if(a>=10&&a<=r-10&&t>=l-5&&t<l+35)return{select:c.code};l+=45}if(n){let c=I.find(h=>h.code===n);if(c){let h=r+20,o=115+Object.keys(c.req).length*25+20;if(a>=h&&a<=h+120&&t>=o&&t<=o+40)return{craft:!0}}}return{}}function q(a,t,e,i,s,n){let r=s/2;a.fillStyle="white",a.textAlign="center",a.font="20px sans-serif",a.fillText("Achievements",r/2,30);let l=60,c=new Set(t.achievements);for(let h of e){let o=c.has(h.id);i===h.id&&(a.fillStyle="#444",a.fillRect(10,l-20,r-20,30)),a.fillStyle=o?"#fb4":"#888",a.textAlign="left",a.font="16px sans-serif",a.fillText(`${o?"\u2605":"\u{1F512}"} ${h.name}`,20,l),l+=35}if(i){let h=e.find(o=>o.id===i);if(h){let o=r+20,f=60;a.fillStyle="white",a.textAlign="left",a.font="bold 20px sans-serif",a.fillText(h.name,o,f),a.font="14px sans-serif",a.fillStyle="#ccc",a.fillText(h.description,o,f+30),a.fillStyle="#8f8",a.fillText(`Reward: +${(h.stat_bonus[1]*100).toFixed(0)}% ${h.stat_bonus[0]}`,o,f+60);let u=c.has(h.id);a.fillStyle=u?"#4f4":"#f44",a.fillText(u?"UNLOCKED":"LOCKED",o,f+90)}}}function E(a,t,e,i,s){let n=e/2,r=60;for(let l of s){if(a>=10&&a<=n-10&&t>=r-20&&t<=r+10)return l.id;r+=35}return null}function O(a,t,e,i,s,n,r){a.fillStyle="white",a.textAlign="center",a.font="24px sans-serif",a.fillText("Player Profile",e/2,40),a.font="18px sans-serif",a.fillText(`ID: ${t.id.substring(0,8)}...`,e/2,80);let l=120;a.textAlign="left",a.font="16px monospace";let c=[`Kills: ${t.stats?.mobs_killed??0}`,`Deaths: ${t.stats?.deaths??0}`,`Crafted: ${t.stats?.items_crafted??0}`,`Steps: ${t.stats?.steps_taken??0}`];for(let b of c)a.fillText(b,e/2-80,l),l+=25;let h=240,o=45,f=(e-h)/2,u=l+20;a.fillStyle=n?"#000":"#111",a.fillRect(f,u,h,o),a.strokeStyle=n?"#4a4":"#555",a.strokeRect(f,u,h,o),a.fillStyle="white",a.textAlign="left";let d=s;n&&Date.now()%1e3<500&&(d+="|"),a.fillText(d||(n?"":"Type Name..."),f+10,u+30),r.drawBtn(a,(e-160)/2,u+60,160,40,"Update Name",!1)}function j(a,t,e,i,s,n){let r=220,l=240,c=45,h=(e-l)/2,o=r+20;return n.hit(a,t,h,o,l,c)?{focus:!0}:n.hit(a,t,(e-160)/2,o+60,160,40)?{update:!0}:{focus:!1}}function L(a,t,e,i){a.fillStyle="#111",a.fillRect(0,0,t,e),a.fillStyle="#eee",a.font="bold 60px sans-serif",a.textAlign="center",a.fillText("kkmypk",t/2,e/3),i.drawBtn(a,(t-200)/2,e/2,200,60,"PLAY",!0)}function X(a,t,e,i){a.fillStyle="rgba(0,0,0,0.9)",a.fillRect(0,0,t,e),a.fillStyle="white",a.font="bold 60px sans-serif",a.textAlign="center",a.fillText("YOU DIED",t/2,e/3),i.drawBtn(a,(t-300)/2,e/2,300,80,"Return to Menu",!0)}var z=[{id:"NoviceWalker",name:"Novice Walker",description:"Walk 1,000 steps",stat_bonus:["speed",.01]},{id:"MarathonRunner",name:"Marathon Runner",description:"Walk 100,000 steps",stat_bonus:["speed",.05]},{id:"FirstBlood",name:"First Blood",description:"Kill 1 mob",stat_bonus:["damage",.01]},{id:"MonsterHunter",name:"Monster Hunter",description:"Kill 100 mobs",stat_bonus:["damage",.02]},{id:"Slayer",name:"Slayer",description:"Kill 1,000 mobs",stat_bonus:["damage",.05]},{id:"Lumberjack",name:"Lumberjack",description:"Chop 100 trees",stat_bonus:["gather",.02]},{id:"Deforestation",name:"Deforestation",description:"Chop 1,000 trees",stat_bonus:["gather",.05]},{id:"Miner",name:"Miner",description:"Mine 100 rocks",stat_bonus:["gather",.02]},{id:"DeepDriller",name:"Deep Driller",description:"Mine 1,000 rocks",stat_bonus:["gather",.05]},{id:"ApprenticeSmith",name:"Apprentice Smith",description:"Craft 10 items",stat_bonus:["craft",.02]},{id:"MasterSmith",name:"Master Smith",description:"Craft 1,000 items",stat_bonus:["craft",.05]},{id:"Builder",name:"Builder",description:"Place 50 structures",stat_bonus:["max_hp",.05]},{id:"Architect",name:"Architect",description:"Place 500 structures",stat_bonus:["max_hp",.2]}],T=class{constructor(){this.state=k.StartScreen;this.isMenuOpen=!1;this.activeTab=0;this.joinRequest=!1;this.craftRequest=null;this.slotSelectRequest=null;this.respawnRequest=!1;this.nameUpdateRequest=null;this.swapRequest=null;this.drag=null;this.nameBuffer="";this.isNameFocused=!1;this.toast=null;this.selectedAchId=null;this.selectedRecipe=null}showAchievement(t){this.toast={ach:t,start:Date.now()}}render(t,e,i){let s=t.canvas.width,n=t.canvas.height;e&&this.activeTab===2&&!this.isNameFocused&&(this.nameBuffer=e.username),this.state===k.StartScreen?L(t,s,n,this):this.state===k.GameOver?X(t,s,n,this):this.state===k.InGame&&e&&(this.drawHotbar(t,e,s,n),this.drawHUD(t,s),this.isMenuOpen&&this.drawMenu(t,e,s,n),this.drag&&(t.save(),t.globalAlpha=.7,this.drawItem(t,this.drag.item,i.mouseX-30,i.mouseY-30,60),t.restore()),this.toast&&this.drawToast(t,s,n))}drawHUD(t,e){let i=e-60,s=20,n=50;t.fillStyle=this.isMenuOpen?"rgba(74,164,74,0.6)":"rgba(68,68,68,0.6)",t.fillRect(i,s,n,n),t.strokeStyle="#fff",t.strokeRect(i,s,n,n),t.fillStyle="white",t.fillRect(i+10,s+12,30,4),t.fillRect(i+10,s+23,30,4),t.fillRect(i+10,s+34,30,4)}drawMenu(t,e,i,s){t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(0,0,i,s);let n=20,r=n,l=n,c=i-n*2,h=s-n*2;t.fillStyle="rgba(34,34,34,0.95)",t.fillRect(r,l,c,h),t.strokeStyle="#444",t.strokeRect(r,l,c,h),this.drawBtn(t,r+c-40,l+10,30,30,"X",!1);let o=["Bag","Craft","Prof","Help","Achiev"],f=(c-50)/o.length;for(let u=0;u<o.length;u++)this.drawBtn(t,r+u*f,l,f,50,o[u],u===this.activeTab);if(t.save(),t.translate(r,l+50),this.activeTab===0)C(t,e,c,h-50,this.drag,this);else if(this.activeTab===1)W(t,e,this.selectedRecipe,c,h-50,this);else if(this.activeTab===2)O(t,e,c,h-50,this.nameBuffer,this.isNameFocused,this);else if(this.activeTab===3){t.fillStyle="white",t.textAlign="left";let u=40;for(let d of["WASD: Move","LeftClick/Space: Attack/Use","RightClick/Shift: Interact","1-7: Slot"])t.fillText(d,20,u),u+=25}else this.activeTab===4&&q(t,e,z,this.selectedAchId,c,h-50);t.restore()}drawToast(t,e,i){if(!this.toast)return;let s=Date.now()-this.toast.start;if(s>3e3){this.toast=null;return}let n=s<200?s/200:s>2800?(3e3-s)/200:1;t.save(),t.globalAlpha=n;let r=300,l=60,c=(e-r)/2,h=i-150;t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(c,h,r,l),t.strokeStyle="#fb4",t.strokeRect(c,h,r,l),t.fillStyle="#fb4",t.font="bold 16px sans-serif",t.textAlign="center",t.fillText("ACHIEVEMENT UNLOCKED!",c+r/2,h+20),t.fillStyle="white",t.font="14px sans-serif",t.fillText(this.toast.ach.name,c+r/2,h+45),t.restore()}drawHotbar(t,e,i,s){let r=Math.min(50,(i-80)/7),l=10,c=(i-7*(r+l))/2,h=s-r-20;for(let o=0;o<7;o++){let f=c+o*(r+l);t.fillStyle=o===e.active_slot?"#aa0":"#000",t.globalAlpha=.5,t.fillRect(f,h,r,r),t.globalAlpha=1,t.strokeStyle="#fff",t.strokeRect(f,h,r,r);let u=e.inventory.slots[o];u&&(!this.drag||this.drag.fromIndex!==o)&&this.drawItem(t,u,f,h,r)}}drawItem(t,e,i,s,n){t.fillStyle=e.kind.includes("Wood")?"#852":e.kind.includes("Stone")?"#888":e.kind.includes("Meat")?"#f88":"#e22",t.beginPath(),t.arc(i+n/2,s+n/2,n/3,0,Math.PI*2),t.fill(),t.fillStyle="white",t.font="12px sans-serif",t.textAlign="right",t.fillText(e.amount.toString(),i+n-4,s+n-4)}drawBtn(t,e,i,s,n,r,l){t.fillStyle=l?"#4a4":"#444",t.fillRect(e,i,s,n),t.strokeStyle="#fff",t.strokeRect(e,i,s,n),t.fillStyle="white",t.textAlign="center",t.textBaseline="middle",t.font="14px sans-serif",t.fillText(r,e+s/2,i+n/2)}handleInput(t,e,i,s){if(this.isNameFocused){let n=t.keyQueue.shift();n==="Enter"?(this.nameUpdateRequest=this.nameBuffer,this.isNameFocused=!1):n==="Backspace"?this.nameBuffer=this.nameBuffer.slice(0,-1):n&&n.length===1&&(this.nameBuffer+=n)}else t.keyQueue=[];if(t.isPointerDown){let n=t.mouseX,r=t.mouseY;if(this.state===k.StartScreen&&this.hit(n,r,(e-200)/2,i/2,200,60))this.joinRequest=!0;else if(this.state===k.GameOver&&this.hit(n,r,(e-300)/2,i/2,300,80))this.respawnRequest=!0;else if(this.state===k.InGame)if(this.isMenuOpen){let o=e-40,f=i-20*2;if(this.hit(n,r,20+o-40,30,30,30))this.isMenuOpen=!1;else if(this.hit(n,r,20,20,o,50))this.activeTab=Math.floor((n-20)/(o/5));else{let u=n-20,d=r-70;if(u>=0&&d>=0&&u<=o&&d<=f-50){if(this.activeTab===0&&s){let b=B(u,d,o,f-50,s,this);b&&(this.drag=b)}else if(this.activeTab===1&&s){let b=_(u,d,o,f-50,s,this.selectedRecipe);b.select&&(this.selectedRecipe=b.select),b.craft&&(this.craftRequest=this.selectedRecipe)}else if(this.activeTab===2&&s){let b=j(u,d,o,f-50,s,this);b.focus?(this.isNameFocused=!0,this.nameBuffer=s.username):b.update?(this.nameUpdateRequest=this.nameBuffer,this.isNameFocused=!1):this.isNameFocused=!1}else if(this.activeTab===4){let b=E(u,d,o,f-50,z);b&&(this.selectedAchId=b)}}}}else{this.hit(n,r,e-60,20,50,50)&&(this.isMenuOpen=!0);let l=7,c=Math.min(50,(e-80)/7),h=10,o=(e-l*(c+h))/2,f=i-c-20;if(this.hit(n,r,o,f,l*(c+h),c)){let u=Math.floor((n-o)/(c+h));u>=0&&u<7&&(this.slotSelectRequest=u)}}t.isPointerDown=!1}if(this.drag&&!t.isPointerDown&&s){let n=t.mouseX,r=t.mouseY;this.drag=null}}hit(t,e,i,s,n,r){return t>=i&&t<=i+n&&e>=s&&e<=s+r}};var S=new P,x=new A,m=new T,g=null,Y=null,H=0,w=null,y=null,p=null,M="kkmypk_token";function $(){let a=location.protocol==="https:"?"wss":"ws",t=localStorage.getItem(M),e=`${a}://${location.host}/ws${t?`?token=${t}`:""}`;y=new WebSocket(e),y.onmessage=i=>{try{let s=JSON.parse(i.data);s.type==="welcome"?(w=s.id,s.token&&localStorage.setItem(M,s.token),m.state=v.InGame):s.type==="world"?(Y=g,g=s.data,H=Date.now(),m.state===v.InGame&&w&&g&&!g.players[w]&&(m.state=v.GameOver)):s.type==="achievement"&&m.showAchievement(s.data)}catch(s){console.error("Parse error",s)}},y.onopen=()=>{console.log("Connected"),p&&clearInterval(p),p=setInterval(G,50)},y.onclose=()=>{m.state=v.StartScreen,g=null,w=null,p&&(clearInterval(p),p=null)}}function N(){let a=w&&g?g.players[w]:null;if(m.handleInput(x,S.canvas.width,S.canvas.height,a),x.updateAnimations(16),m.state===v.StartScreen)m.render(S.ctx,null,x),m.joinRequest&&($(),m.joinRequest=!1);else if(m.state===v.GameOver)m.render(S.ctx,null,x),m.respawnRequest&&(m.respawnRequest=!1,y&&(y.close(),y=null),p&&(clearInterval(p),p=null),localStorage.removeItem(M),location.reload());else{let t=Date.now(),e=Math.min(1,(t-H)/50);S.render(g,Y,e,x,w,m),y&&y.readyState===WebSocket.OPEN&&(m.craftRequest&&(y.send(JSON.stringify({craft:m.craftRequest})),m.craftRequest=null),m.slotSelectRequest!==null&&(y.send(JSON.stringify({slot:m.slotSelectRequest})),m.slotSelectRequest=null),m.nameUpdateRequest&&(y.send(JSON.stringify({name:m.nameUpdateRequest})),m.nameUpdateRequest=null),m.swapRequest&&(y.send(JSON.stringify({swapSlots:m.swapRequest})),m.swapRequest=null))}requestAnimationFrame(N)}function G(){if(y&&y.readyState===WebSocket.OPEN&&m.state===v.InGame){let a=x.getState();(a.dx!==0||a.dy!==0||a.attack||a.interact||x.isPointerDown)&&y.send(JSON.stringify(a))}}N();})();
